<!doctype html>
<html>
<head>
<title>Twitter News</title>

<link rel="stylesheet" href="static/css/original.css"/>

<script src="static/js/jquery-1.6.4.min.js"></script>
<script src="static/js/jquery.masonry.min.js"></script>
<script src="static/js/jquery.wordcloud.js"></script>

<script src="https://www.google.com/jsapi?key=ABQIAAAAVq_ezpCP6r9ct3n9o8VV4hRqSHJGvvNPApRNCRW5oia_vxvJeRS6Bcd_ACwcm1qSmZcU7cSDOrqt6Q" type="text/javascript"></script>

<script type="text/javascript">

google.load("search", "1");
function boxSearch(boxnum) {
  return function(searcher) {
    if (searcher.results && searcher.results.length > 0) {
      var results = searcher.results;
      var i = 0;
      
        var result = results[i];
        var src = result.url;
        
      $("#bp"+boxnum).attr('src',src);
      $("#bp"+boxnum).onError = backupUrl(result.tbUrl);
    }
  }
}

function OnLoad() {
  console.log("Google Ready!");
}
google.setOnLoadCallback(OnLoad);

function addBox(id) {
  box = ""
  + "<div id='b" + id + "' class='box col' onclick='boxClick(" + id + ");'>"
  +   "<div id='bt" + id + "' class='boxw' style='width:190px; height:130px; overflow:hidden;'><h2>Title</h2><p>Summary</p></div>"
  +   "<div class='boxw' style='width:190px; height:130px; float:right;'><div style='width:190px; height:130px; overflow:hidden;'><img id='bp" + id + "' style='width:inherit;' src='static/images/twitter.png'></div></div>"
  +   "<div class='boxw' style='width:190px; height:60px;'>Sentiment</div>"
  +   "<div id='btw" + id + "' class='boxw' style='width:190px; height:250px; float:right;'>Tweets</div>"
  +   "<div class='boxw' style='width:190px; height:170px;'><canvas id='bwc" + id + "' width='190' height='170'></div>"
  + "</div>";
  $("#container").append(box);
}

function changeBox(boxnum) {
    return function(data) {
      if (!document.getElementById("b" + boxnum)) { 
        addBox(boxnum);
        $('#container').masonry('reload');
      }
      $("#bt"+boxnum).html("<h2>" + data.title + "</h2><p>" + data.summary + "</p>");
      
      var cloud = new Array();
      for(var i in data.wordcloud) {
        cloud.push([i, data.wordcloud[i]*12]);
      }
      if(cloud.length == 0) {
        cloud.push(['none', 30]);
      }
      $("#bwc"+boxnum).wordCloud({wordList: cloud});
      
      var imageSearch = new google.search.ImageSearch();
      //imageSearch.setRestriction(google.search.ImageSearch.RESTRICT_IMAGESIZE, google.search.ImageSearch.IMAGESIZE_MEDIUM);
      imageSearch.setSearchCompleteCallback(this, boxSearch(boxnum), [imageSearch]);

      imageSearch.execute('"' + data.title + '"');
    }
}

function boxClick(boxnum) {
  console.log($("#bwc"+boxnum));
}

$(document).ready(function() {
  $('#container').masonry({
    // options
    itemSelector : '.box',
    isAnimated: true,
    isFitWidth: true
  });
  
  $.getJSON("api/news", function(data) {
    for(i = 0; i < data.news.length; i++) {
      $.getJSON("api/story/"+data.news[i], changeBox(i));
    }
  });
});

function backupUrl(url) {
  return function() {
    $(this).attr('src',url);
  }
}

</script>

</head>
<body>

<div id="container" class="centered">
</div>

</body>
</html>
