<!doctype html>
<html>
<head>
	<title>Twitter News</title>
	<link rel="stylesheet" href="static/css/original.css"/>
	<link rel="stylesheet" href="static/css/sam.css"/>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
	<!--	<script type="text/javascript" src="static/js/jquery-ui-1.8.16.custom.min.js"></script> -->
	<script type="text/javascript" src="static/js/jquery.masonry.min.js"></script>
	<script type="text/javascript" src="static/js/jquery.wordcloud.js"></script>
	<script type="text/javascript" src="static/js/jquery.easing.1.3.js"></script>
	<!--	<script type="text/javascript" src="static/js/jquery.mCustomScrollbar.js"></script>	-->
	
	<!--	<script src="https://www.google.com/jsapi?key=ABQIAAAAVq_ezpCP6r9ct3n9o8VV4hRqSHJGvvNPApRNCRW5oia_vxvJeRS6Bcd_ACwcm1qSmZcU7cSDOrqt6Q" type="text/javascript"></script>	-->

	<!--This key is registered to twitter.rafal.io-->
		<script src="https://www.google.com/jsapi?key=ABQIAAAAUNr1ui41kSiUfappfALFIBRqSHJGvvNPApRNCRW5oia_vxvJeRQ9FKL9VrNCGjMZDsP8oZ7S50XAJQ" type="text/javascript"></script>
	
	
	<!-- Scrolling -->
	<link type="text/css" href="static/css/jquery.jscrollpane.css" rel="stylesheet" media="all" />
	<script type="text/javascript" src="static/js/jquery.mousewheel.min.js"></script>
	<script type="text/javascript" src="static/js/jquery.jscrollpane.min.js"></script>
		
	<!-- endScrolling -->


	<script type="text/javascript">
	var box_images = new Array();	//saves the array of images for each box
	var best_match_tb = new Array(); //saves the array of best match thumbnail
	var imageSeachers = new Array();
	var imageSeachersPage = new Array();
	var verbose = 0;
	google.load("search", "1");

	//boxSearch is a function that assign image to a box
	function boxSearch(boxnum) {
		return function(searcher) {
			if(searcher.results && searcher.results.length > 0){
				box_images[boxnum] = searcher.results;
				if (searcher.results && searcher.results.length > 0 && !best_match_tb[boxnum]) {
					best_match_tb[boxnum] = box_images[boxnum][0].tbUrl;	//save the best thumbnail
				}
				if(verbose) console.log('received results for ' + boxnum);
				if(verbose) console.log(box_images);
				useNextBestImg(boxnum);
			}
		}
	}

	function imgCheck(boxnum, url){
		if(verbose) console.log(boxnum + " is checking " + url);
		var img = new Image();
		img.onload=function() {imgExist(boxnum,url);};
		img.onerror=function() {useNextBestImg(boxnum);};
		img.src=url;
		
	}

	function imgExist(boxnum,url){
		if(verbose) console.log(boxnum + " is set to use " + url);
		$("#box"+boxnum).css('background-image', 'url(' + url + ')');
	}
	
	function useNextBestImg(boxnum){
		if(verbose) console.log(boxnum + "is looking for a image in page " + imageSeachersPage[boxnum]);
		if (box_images[boxnum] && box_images[boxnum].length > 0) {
			// guarenteed: length > 0
			while(
				box_images[boxnum].length > 0	//there's more
				&& (box_images[boxnum][0].height < 300 || box_images[boxnum][0].width < 300)	//and img too small (used to check 140 200)
			){
				if(verbose) console.log(boxnum + " dumped a img");
				box_images[boxnum].shift();	//throw the head away
			}	
			//Post: we ran out / we have sufficiently large img
			if(box_images[boxnum].length > 0){
				//we have sufficiently large img
				imgCheck(boxnum, box_images[boxnum][0].url);
				box_images[boxnum].shift();
			}else{
				//we ran out
				if(imageSeachersPage[boxnum] > 8){
					// Damn, nothing useful after 8 pages / 64 images. Just load the thumb, it's equally shit
					if(verbose) console.log("box" + boxnum + " has no suitable img, using thumb " + best_match_tb[boxnum]);
					$("#box"+boxnum).css('background-image', 'url(' + best_match_tb[boxnum] + ')');
				}else{
					imageSeachersPage[boxnum]++;
					if(verbose) console.log("box" + boxnum + " is looking at page " + imageSeachersPage[boxnum]);
					imageSeachers[boxnum].gotoPage(imageSeachersPage[boxnum]);
					// box_images[boxnum] = imageSeachers[boxnum].results;
					// if(verbose) console.log(imageSeachers[boxnum].results);
					// if(verbose) console.log(box_images[boxnum]);
					// That's the best we are going to do
				}
			}       
		}else{
			//we need more image search results.
			if(imageSeachersPage[boxnum] > 8){
				// Damn, nothing useful after 8 pages / 64 images. Just load the thumb, it's equally shit
				if(verbose) console.log("box" + boxnum + " has no suitable img, using thumb " + best_match_tb[boxnum]);
				$("#box"+boxnum).css('background-image', 'url(' + best_match_tb[boxnum] + ')');
			}else{
				imageSeachersPage[boxnum]++;
				if(verbose) console.log("box" + boxnum + " is looking at page " + imageSeachersPage[boxnum]);
				imageSeachers[boxnum].gotoPage(imageSeachersPage[boxnum]);
				// box_images[boxnum] = imageSeachers[boxnum].results;
				// if(verbose) console.log(imageSeachers[boxnum].results);
				// if(verbose) console.log(box_images[boxnum]);
				// useNextBestImg(boxnum);
				// That's the best we are going to do
			}
		}
	}

	function addBox(id) {
		box = ""
		+ "<div id='box" + id + "' class='box col'>"	// onClick='boxClick(" + id + ");'
		+	"<div id='description" + id + "' class='titlecard'>"
		+   "</div>"		
		+	"<div class='mask mask-1'></div>	    <div class='mask mask-2'></div>"
		+ 	"<div class='details' style=''>"
		+		"<div class='left' style='width:200px; height:400px; float:left'>"
		+   		"<div class='boxw' style='margin-bottom: 10px;height:50%'>"
		+     			"<div id='article" + id + "' class='scrollable' style=''>"
		+				"</div>"
		+   		"</div>"		
		+   		"<div id='wordcloud" + id + "' class='boxw' style='height:165px'></div>"
		+	   "</div>"		
		+		"<div class='right' style='width:200px; height:400px; float:left;'>"
		+   		"<div id='tweets" + id + "' class='boxw scrollable' style='height:395px'>"
		// +     			"<h2>Recent Tweets:</h2>"
		+				"<span id='addtweet" + id + "'/>";
		+   	  	"</div>"
		+   	"</div>"		
		+   "</div>"		
		+ "</div>";
		$("#container").append(box);
		var canvasDivWidth = $("#wordcloud" + id).width();
		var canvasDivHeight = $("#wordcloud" + id).height();
		$("#wordcloud" + id).append("<canvas id='wordcloudcanvas" + id + "' width='" + canvasDivWidth + "' height='" + canvasDivHeight + "'>");
		$('#box' + id).toggle(function() {
			//First time clicked
			if(verbose) console.log("Clicked box"+id);
			// $('#box' + id + ' .details').toggle();
			var target = $('#box' + id);
			target.addClass('box-hover');
			if(verbose) console.log('moving box' + id + ' to the front');
			// $('#box' + id).children(' .mask-1 ,  .mask-2').css('background', 'rgba(123,0,0,0.5)');
			$('#box' + id).css('border', 'solid red 1px');
			$('#container').prepend(target).masonry('reload');
		}, function() {
		 	//Revert
			if(verbose) console.log("Clicked box"+id);
			// $('#box' + id + ' .details').toggle();
			var target = $('#box' + id);
			target.removeClass('box-hover');
			if(verbose) console.log('moving box' + id + ' to the back');
			// $('#box' + id).children(' .mask-1 ,  .mask-2').css('background', 'rgba(123,0,0,0.5)');
			$('#box' + id).css('border', '');
			$('#container').append(target).masonry('reload');
		});
	}

	function changeBox(boxnum) {
		return function(data) {
			if (!document.getElementById("box" + boxnum)) { 
				addBox(boxnum);
				$('#container').masonry('reload');
			}
			$("#description"+boxnum).html("<h1>" + data.title + "</h1>");
			$("#article"+boxnum).html("<h2>" + data.title + "</h2><p>" + data.summary + "</p>");
			// $("#btc"+boxnum).mCustomScrollbar("vertical",300,"easeOutCirc",1.05,"fixed","yes","no",1);

			var cloud = new Array();
			for(var i in data.wordcloud) {
				cloud.push([i, data.wordcloud[i]*12]);
			}
			if(cloud.length == 0) {
				cloud.push(['none', 30]);
			}
			$("#wordcloudcanvas"+boxnum).wordCloud({wordList: cloud});

			var imageSearch = new google.search.ImageSearch();
			imageSeachers[boxnum] = imageSearch;
			imageSeachersPage[boxnum] = 0;
			imageSearch.setNoHtmlGeneration();
			imageSearch.setResultSetSize(8);
			imageSearch.setRestriction(
			  google.search.Search.RESTRICT_SAFESEARCH,
			  google.search.Search.SAFESEARCH_OFF
			);	//Will we ever get porn? ;)
			
			// imageSearch.setRestriction(
			// 	google.search.ImageSearch.RESTRICT_IMAGESIZE, 
			// 	google.search.ImageSearch.IMAGESIZE_LARGE
			// );
			
			// var searcher = new google.search.ImageSearch();
			// searcher.setRestriction(google.search.ImageSearch.RESTRICT_RIGHTS,
			//                         google.search.ImageSearch.RIGHTS_MODIFICATION
			// );	// Remove comments to be Ethicial 
			
			imageSearch.setSearchCompleteCallback(this, boxSearch(boxnum), [imageSearch]);
			imageSearch.execute('' + data.title + '');

			if(data.keywords.length > 0)
				$.ajax({type: "GET", url: "http://search.twitter.com/search.json?q="+data.keywords[0]+"&rpp=10&result_type=mixed", dataType: "jsonp", success: parseTweets(boxnum)});
		}
	}

	function parseTweets(boxnum) {
		return function(data) {
			for(i = 0; i < data.results.length; i++) {
				var box = "<p style='width:inherit;'><strong>" + data.results[i].from_user + ":</strong> " + data.results[i].text + "</p>"
				$("#addtweet"+boxnum).append(box);
			}
			$('.scrollable').jScrollPane({});
		}
	}

	/* Not used anymore
	function boxClick(boxnum) {
		if(verbose) console.log("Clicked box"+boxnum);
		// $('#box' + boxnum + ' .details').toggle();
		var target = $('#box' + boxnum);
		target.addClass('box-hover');
		if(verbose) console.log('moving box' + boxnum + ' to the front');
		// $('#box' + boxnum).children(' .mask-1 ,  .mask-2').css('background', 'rgba(123,0,0,0.5)');
		$('#box' + boxnum).css('border', 'solid red 1px');
		$('#container').prepend(target).masonry('reload');
	}
	*/

	$(document).ready(function() {
		$('#container').masonry({
			// options
			itemSelector : '.box',
			isAnimated: true,
			isFitWidth: true
		});

		$.getJSON("api/news", function(data) {
			for(i = 0; i < data.news.length; i++) {
				$.getJSON("api/story/"+data.news[i], changeBox(i));
			}
		});
	});

	</script>

</head>
<body>

	<div id="container" class="centered"></div>

</body>
</html>
